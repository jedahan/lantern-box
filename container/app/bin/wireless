#!/bin/bash

if [[ $UID != 0 ]]; then
    echo "Please run this script with sudo:"
    echo "sudo $0 $*"
    exit 1
fi

reset() {
  systemctl stop netctl-auto@wlan0
  sleep 1
  ifconfig wlan0 down
  sleep 1
  rfkill block wlan
  sleep 1
  rfkill unblock wlan
  sleep 1
  ifconfig wlan0 up
  sleep 1
}


register() {
  wifi_ssid=$1
  echo "registering new wireless network: $wifi_ssid"
  
  echo "encrypting wifi pass..."
  wifi_pass=`wpa_passphrase ${wifi_ssid} <<< ${2} | grep -oE '(psk=)[a-zA-Z0-9]*$' | tr -d 'psk='`

  if [[ -f /etc/netctl/wireless-internet ]]; then
    rm /etc/netctl/wireless-internet > /dev/null
  fi

  touch /etc/netctl/wireless-internet
  cat <<EOF >"/etc/netctl/wireless-internet"
  Description="Lantern Wireless Internet"
  Interface=wlan0
  Connection=wireless
  Security=wpa
  ESSID="${wifi_ssid}"
  IP=dhcp
  Key="${wifi_pass}"
EOF
  echo "wrote new wireless-internet file..."
}

internet() {
  echo "preparing wireless internet..."
  systemctl stop hostapd
  sleep 5
  netctl start wireless-internet
  echo "wireless internet enabled..."
}

hotspot() {
    echo "configuring access point. you may need to reconnect..."
    # shut down any existing connections
    reset
    sleep 1
    netctl stop wireless-internet

    # setup our access point with static ip
    cp -rf /opt/lantern/network/hostapd.conf /etc/hostapd/hostapd.conf
    dnsmasq -C /opt/lantern/network/dnsmasq.conf
    systemctl enable dhcpcd
    systemctl start dhcpcd
    hostapd /opt/lantern/network/hostapd.conf
}

pollinate() {
  echo "preparing wireless pollinate..."
  systemctl stop hostapd
  sleep 5
  netctl start wireless-internet
}


help() {
  echo "Please choose between network modes: hotspot, internet, pollinate"
}

#-----------------------------------------------------------------------------

until
    cmd=$1
    if [ -z "$cmd" ]; then
        help
    fi
    shift 1
    $cmd "$@"
    [ "$?" -ne 127 ]
do
    help
    exit
done
