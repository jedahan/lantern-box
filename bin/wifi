#!/bin/bash
WIFI_DESC=${WIFI_DESC:-Lantern}
WIFI_SSID=${WIFI_SSID:-my-router}
WIFI_PASS=${WIFI_PASS:-my-pass}

echo "#############################################"
echo "## Configuring WiFi Network"
echo "#############################################"

# Install zero-conf to make the pi easier to find on the network
sed -i '/^hosts: /s/files dns/files mdns dns/' /etc/nsswitch.conf
ln -sf /usr/lib/systemd/system/avahi-daemon.service /etc/systemd/system/multi-user.target.wants/avahi-daemon.service

# Enable wireless, actual connection details will be configured by the user, likely over usb-serial.
# Do not put any secrets like wifi passphrases in here as they will be publicly exposed in the repo and image.
ln -sf /usr/lib/systemd/system/netctl-auto@.service /etc/systemd/system/multi-user.target.wants/netctl-auto@wlan0.service
ln -sf /usr/lib/systemd/system/netctl-ifplugd@.service /etc/systemd/system/multi-user.target.wants/netctl-ifplugd@eth0.service

touch /etc/netctl/wlan0-SSID
cat <<EOF >"/etc/netctl/wlan0-SSID"
Description="${WIFI_DESC}"
Interface=wlan0
Connection=wireless
Security=wpa
ESSID="${WIFI_SSID}"
IP=dhcp
Key="${WIFI_PASS}"
EOF

echo "using WiFi network: ${WIFI_SSID}"
