#!/bin/bash

if [[ $UID != 0 ]]; then
    echo "Please run this script with sudo:"
    echo "sudo $0 $*"
    exit 1
fi

function parse_yaml {
   local prefix=$2
   local s='[[:space:]]*' w='[a-zA-Z0-9_]*' fs=$(echo @|tr @ '\034')
   sed -ne "s|^\($s\):|\1|" \
        -e "s|^\($s\)\($w\)$s:$s[\"']\(.*\)[\"']$s\$|\1$fs\2$fs\3|p" \
        -e "s|^\($s\)\($w\)$s:$s\(.*\)$s\$|\1$fs\2$fs\3|p"  $1 |
   awk -F$fs '{
      indent = length($1)/2;
      vname[indent] = $2;
      for (i in vname) {if (i > indent) {delete vname[i]}}
      if (length($3) > 0) {
         vn=""; for (i=0; i<indent; i++) {vn=(vn)(vname[i])("_")}
         printf("%s%s%s=\"%s\"\n", "'$prefix'",vn, $2, $3);
      }
   }'
}
#-----------------------------------------------------------------------------

if [[ -f /opt/lantern/config.yml ]]; then
  eval $(parse_yaml /opt/lantern/config.yml)
fi

reset() {
  systemctl stop netctl-auto@wlan0
  sleep 1
  ifconfig wlan0 down
  sleep 1
  rfkill block wlan
  sleep 1
  rfkill unblock wlan
  sleep 1
  ifconfig wlan0 up
  sleep 1
}


register() {
  wifi_ssid=$1
  echo "registering new wireless network: $wifi_ssid"
  
  echo "encrypting wifi pass..."
  wifi_pass=`wpa_passphrase ${wifi_ssid} <<< ${2} | grep -oE '(psk=)[a-zA-Z0-9]*$' | tr -d 'psk='`

  if [[ -f /etc/netctl/wireless-internet ]]; then
    rm /etc/netctl/wireless-internet > /dev/null
  fi

  touch /etc/netctl/wireless-internet
  cat <<EOF >"/etc/netctl/wireless-internet"
  Description="Lantern Wireless Internet"
  Interface=wlan0
  Connection=wireless
  Security=wpa
  ESSID="${wifi_ssid}"
  IP=dhcp
  Key="${wifi_pass}"
EOF
  echo "wrote new wireless-internet file..."
}

internet() {
  echo "preparing wireless internet..."
  create_ap --stop wlan0
  sleep 5
  netctl start wireless-internet
  echo "wireless internet enabled..."
}

ap() {
    if [ "${LANTERN_ID}" == "" ]; then
      echo "please set your device id with init before running access point"
      exit
    fi  
    local_ssid="LANTERN-${LANTERN_ID}"
    echo "configuring access point: ${local_ssid}"
    echo "you will need to reconnect through a shared wireless network..."
    reset
    sleep 1
    netctl stop wireless-internet
    create_ap --hostapd-debug 2 --redirect-to-localhost --daemon --no-virt -n wlan0 "$local_ssid"
}

pollinate() {
  echo "preparing wireless pollinate..."
  create_ap --stop wlan0
  sleep 5
  netctl start wireless-internet
}



help() {
  echo "Please choose between network modes: ap, internet, pollinate"
}

#-----------------------------------------------------------------------------

until
    cmd=$1
    if [ -z "$cmd" ]; then
        help
    fi
    shift 1
    $cmd "$@"
    [ "$?" -ne 127 ]
do
    help
    exit
done
