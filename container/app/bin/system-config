#!/bin/bash

# this script must be run through a Docker context and chroot
# envionment variables will not load directly from a Raspberry Pi
# This script must be run through a Docker context and chroot.
# Environment variables will not load directly from a Raspberry Pi.

ADMIN_PASS=${ADMIN_PASS:-wins}
DB_PASS=${DB_PASS:-my-db-pass}
WIFI_DESC=${WIFI_DESC:-Lantern}
WIFI_SSID=${WIFI_SSID:-my-router}
WIFI_PASS=${WIFI_PASS:-my-pass}


echo "encrypting wifi pass..."
WIFI_PASS=`wpa_passphrase ${WIFI_SSID} <<< ${WIFI_PASS} | grep -oE '(psk=)[a-zA-Z0-9]*$' | tr -d 'psk='`


# @todo make unique even when using same pi image for multiple lanterns
echo "generating unique identifier for lantern..."
LANTERN_ID="$(openssl rand -hex 1)"

echo "saving config to disk..."
touch /opt/lantern/config.yml
chmod go-rw /opt/lantern/config.yml
cat <<EOF >"/opt/lantern/config.yml"
LANTERN_ID: ${LANTERN_ID}
WIFI_SSID: ${WIFI_SSID}
WIFI_PASS: ${WIFI_PASS}
DB_PASS: ${DB_PASS}
EOF


echo "updating pouchdb server config..."
sed -i -e "s/{{db_pass}}/${DB_PASS}/g" /opt/lantern/config.json
chmod go-rw /opt/lantern/config.json



echo "updating admin password..."
echo -e "${ADMIN_PASS}\n${ADMIN_PASS}" | passwd admin

cd /opt/lantern/
sudo chmod -R o-rwx /opt/lantern

# required to make sure node modules can install on our Raspberry Pi
npm config set unsafe-perm true
# work-around to make sure sqlite3 is available for PouchDB adapter
if [ ! -d "/opt/lantern/node_modules/sqlite3" ]; then
    npm install sqlite3@4 --build-from-source
    npm install https://github.com/lantern-works/node-websql/tarball/master
fi

if [[ -d /opt/lantern/node_modules/ ]]; then
    echo "using some cached node_modules..."
fi

# install app requirements
npm install
npm config set unsafe-perm false
# stop using unsafe permissions for npm once we're done installing
