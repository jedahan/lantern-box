#!/bin/bash

if [[ $UID != 0 ]]; then
    echo "Please run this script with sudo:"
    echo "sudo $0 $*"
    exit 1
fi



reset() {
  systemctl stop netctl-auto@wlan0
  sleep 1
  ifconfig wlan0 down
  sleep 1
  rfkill block wlan
  sleep 1
  rfkill unblock wlan
  sleep 1
  ifconfig wlan0 up
  sleep 1
}


###
# Register wireless credentials to tether to existing wireless router
##
register() {
  wifi_ssid=$1
  echo "registering new wireless network: $wifi_ssid"
  
  echo "encrypting wifi pass..."
  wifi_pass=`wpa_passphrase ${wifi_ssid} <<< ${2} | grep -oE '(psk=)[a-zA-Z0-9]*$' | tr -d 'psk='`

  if [[ -f /etc/netctl/tether ]]; then
    rm /etc/netctl/tether > /dev/null
  fi

  touch /etc/netctl/tether
  cat <<EOF >"/etc/netctl/tether"
  Description="Lantern - Tether to Wireless Router"
  Interface=wlan0
  Connection=wireless
  Security=wpa
  ESSID="${wifi_ssid}"
  IP=dhcp
  Key="${wifi_pass}"
EOF
  echo "wrote new netctl file named: tether"
}


###
# tether to existing wireless router
###
tether() {
  echo "preparing tether to wireless router..."
  create_ap --stop wlan0
  sleep 5
  netctl start tether
  echo "tether mode enabled..."
}

ap() {
    local_ssid="LANTERN"
    echo "configuring access point: ${local_ssid}"
    echo "you will need to reconnect through a shared wireless network..."
    reset
    sleep 1
    netctl stop wireless-internet
    create_ap --redirect-to-localhost --daemon --no-virt -n wlan0 "$local_ssid"
}

pollinate() {
  echo "preparing wireless pollinate..."
  create_ap --stop wlan0
  sleep 5
  netctl start wireless-internet
}



help() {
  echo "Please choose between network modes: ap, tether, pollinate"
}

#-----------------------------------------------------------------------------

until
    cmd=$1
    if [ -z "$cmd" ]; then
        help
    fi
    shift 1
    $cmd "$@"
    [ "$?" -ne 127 ]
do
    help
    exit
done
